version: '3.8'

services:
  # Full Content Jumpstart System (Agents + Backend API)
  api:
    build:
      context: ..
      dockerfile: Project/Dockerfile
    container_name: content-jumpstart-api
    ports:
      - "8000:8000"
    environment:
      # Application settings
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - ENVIRONMENT=${ENVIRONMENT:-production}

      # Database
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/content_jumpstart

      # Security
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:5173,http://localhost:3000}

      # Anthropic API (for content generation)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}

      # Rate limiting (70% of Anthropic limits)
      - RATE_LIMIT_REQUESTS_PER_MINUTE=${RATE_LIMIT_REQUESTS_PER_MINUTE:-2800}
      - RATE_LIMIT_TOKENS_PER_MINUTE=${RATE_LIMIT_TOKENS_PER_MINUTE:-280000}

      # Content generation settings
      - PARALLEL_GENERATION=${PARALLEL_GENERATION:-true}
      - MAX_CONCURRENT_API_CALLS=${MAX_CONCURRENT_API_CALLS:-5}

      # Database pool settings (production)
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-40}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}

      # Cache settings
      - CACHE_TTL_SHORT=${CACHE_TTL_SHORT:-300}
      - CACHE_TTL_MEDIUM=${CACHE_TTL_MEDIUM:-600}
      - CACHE_TTL_LONG=${CACHE_TTL_LONG:-3600}

    volumes:
      # Persistent data storage
      - api-data:/app/data
      - api-logs:/app/logs

      # Optional: Mount source for development (comment out for production)
      # COMMENTED OUT: This overwrites the built frontend with local files
      # - .:/app

    depends_on:
      db:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - content-jumpstart

  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: content-jumpstart-db
    environment:
      - POSTGRES_DB=content_jumpstart
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata

    volumes:
      - postgres-data:/var/lib/postgresql/data

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

    networks:
      - content-jumpstart

  # Optional: Operator Dashboard Frontend (React)
  # Uncomment to run dashboard alongside backend
  # dashboard:
  #   build:
  #     context: ./operator-dashboard
  #     dockerfile: Dockerfile
  #   container_name: content-jumpstart-dashboard
  #   ports:
  #     - "80:80"
  #   environment:
  #     - VITE_API_URL=http://api:8000
  #   depends_on:
  #     - api
  #   restart: unless-stopped
  #   networks:
  #     - content-jumpstart

# Persistent volumes
volumes:
  postgres-data:
    driver: local
  api-data:
    driver: local
  api-logs:
    driver: local

# Network for service communication
networks:
  content-jumpstart:
    driver: bridge
